# ==============================================================================
# wsPrism Gateway Configuration
# ==============================================================================
# This configuration controls the "Protection" and "Policy" layers of the gateway.
# It allows operators to define strict resource limits, DoS protection, and
# tenant-specific behaviors without recompiling the server.
# ==============================================================================

version: 1  # (required) Config schema version.

gateway:
  # ----------------------------------------------------------------------------
  # 1. Network & Lifecycle (Transport Layer)
  # ----------------------------------------------------------------------------

  # WebSocket server bind address (Host:Port).
  listen: "0.0.0.0:8080"

  # Server-side heartbeat interval (Ping).
  # The gateway sends PING frames to keep connections alive through load balancers.
  # type: integer (ms)
  ping_interval_ms: 20000

  # Idle timeout (Connection Liveness).
  # If no inbound activity (Pong/Text/Binary) is received within this window,
  # the gateway aggressively closes the session to free up resources.
  # type: integer (ms)
  idle_timeout_ms: 60000

  # Outbound Write Timeout (Slow Consumer Protection).
  # If a client cannot read data fast enough and the OS buffer fills up,
  # write operations will block. If blocking exceeds this time, the client is dropped.
  # type: integer (ms)
  writer_send_timeout_ms: 1500

  # Graceful Shutdown Period.
  # When SIGTERM is received, the gateway stops accepting new connections and
  # waits this long for existing sessions to disconnect cleanly.
  # type: integer (ms)
  drain_grace_ms: 5000


  # ----------------------------------------------------------------------------
  # 2. Handshake Defender (DoS Protection)
  # ----------------------------------------------------------------------------
  # Protects the server from "Connection Storms" and DoS attacks.
  # Checks are performed at the HTTP layer *before* WebSocket upgrade logic runs.
  # Rejected clients receive HTTP 429 Too Many Requests with a `Retry-After` header.
  
  handshake_limit:
    # Master switch for the defender.
    enabled: true

    # Global Limit (Token Bucket):
    # Total connection attempts allowed per second across ALL IPs.
    # Protects the server from total CPU exhaustion.
    global_rps: 500
    global_burst: 1000

    # Per-IP Limit (Token Bucket):
    # Connection attempts allowed per specific IP address.
    # Prevents a single actor from flooding the handshake endpoint.
    per_ip_rps: 10
    per_ip_burst: 20

    # Memory Safety:
    # Max number of unique IP addresses to track in memory.
    # If exceeded, old entries are probabilistically evicted to prevent OOM.
    max_ip_entries: 50000


tenants:
  # ============================================================================
  # Tenant A: "starter_plan" (Strict Resource Governance)
  # ============================================================================
  # Example for a free-tier or shared environment where isolation is critical.
  # ============================================================================
  - id: starter_plan

    limits:
      # Packet Size Limit.
      max_frame_bytes: 4096

      # [NEW in Sprint 5] Resource Governance Limits
      # ------------------------------------------------------------
      
      # 1. Tenant-wide Concurrency Cap.
      # If exceeded, new connections are rejected at HTTP layer (503 Service Unavailable).
      # 0 = Unlimited.
      max_sessions_total: 1000 

      # 2. Total Room Cap.
      # Prevents "Room Spamming" (creating thousands of 1-person rooms).
      max_rooms_total: 500

      # 3. Room Density Limit.
      # Max users allowed in a single room.
      max_users_per_room: 50

      # 4. User Complexity Limit.
      # Max unique rooms a single user can join simultaneously.
      max_rooms_per_user: 5

    policy:
      # Rate Limiting (Post-Handshake traffic control)
      rate_limit_rps: 50
      rate_limit_burst: 100
      rate_limit_scope: connection  # Applied per socket

      # Session Policy
      sessions:
        mode: single                # Only 1 session allowed per user
        max_sessions_per_user: 1
        on_exceed: kick_oldest      # Login elsewhere kicks the previous session

      # Security
      ext_allowlist:
        - "room:join"
        - "room:leave"
        - "chat:send"
      
      hot_allowlist: []             # Binary protocol disabled for this tenant


  # ============================================================================
  # Tenant B: "enterprise_game" (High Performance)
  # ============================================================================
  # Example for a multiplayer game requiring low latency and high concurrency.
  # ============================================================================
  - id: enterprise_game

    limits:
      max_frame_bytes: 65536

      # Relaxed Resource Limits
      max_sessions_total: 100000    # Supports massive scale
      max_rooms_total: 10000
      max_users_per_room: 200       # Large matches/lobbies
      max_rooms_per_user: 0         # Unlimited room joins (e.g., global chat + guild + match)

    policy:
      rate_limit_rps: 2000
      rate_limit_burst: 4000
      rate_limit_scope: connection

      sessions:
        mode: multi                 # Allow PC and Mobile at the same time
        max_sessions_per_user: 4
        on_exceed: deny             # Prevent 5th connection

      # Hot Lane (Binary) Configuration
      # Used for movement/physics data.
      # 'silent' mode drops invalid packets without sending error frames (saves bandwidth).
      hot_error_mode: silent
      hot_requires_active_room: true

      # Routing Whitelist
      ext_allowlist:
        - "room:*"
        - "match:*"
        - "chat:*"
      
      # Binary OpCodes (Service ID : OpCode)
      hot_allowlist:
        - "1:*"   # Service 1 (Movement): All opcodes allowed
        - "2:10"  # Service 2 (Combat): Only opcode 10 allowed


  # ============================================================================
  # Tenant C: "internal_dashboard" (Monitoring Tool)
  # ============================================================================
  - id: internal_sys

    limits:
      max_frame_bytes: 1048576      # Allow large JSON payloads (1MB)
      max_sessions_total: 50
      max_rooms_total: 0
      max_users_per_room: 0
      max_rooms_per_user: 0

    policy:
      rate_limit_rps: 500
      rate_limit_burst: 1000
      rate_limit_scope: tenant      # Shared pool for all dashboard users

      sessions:
        mode: multi
        max_sessions_per_user: 10
        on_exceed: kick_oldest

      ext_allowlist:
        - "sys:*"                   # Allow all system commands
        - "metrics:subscribe"
